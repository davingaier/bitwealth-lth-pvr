# M6 Critical Bug Fixes - 2026-01-05

## Summary

Fixed 3 critical bugs discovered during Milestone 6 (Customer Active) testing:

1. **[CRITICAL]** customer_strategies sync issue (Customer 39 not in trading pipeline)
2. **[NON-CRITICAL]** trade_start_date not populating  
3. **[CRITICAL]** CI bands fetching today's data instead of yesterday's

## Bug 1: customer_strategies Sync Issue

### Problem
- When `ef_deposit_scan` activated customers (status='deposit' → 'active'), it updated `customer_details.registration_status` and `customer_portfolios.status`
- **BUT** it did NOT create the required row in `lth_pvr.customer_strategies`
- `ef_generate_decisions` requires `customer_strategies.live_enabled=true` to include customers in trading pipeline
- **Result:** Customer 39 was activated but had no trading decisions generated today (2026-01-05)

### Root Cause
The activation logic was incomplete. The system has 3 places where customer status is tracked:
1. `public.customer_details.registration_status` (prospect → kyc → setup → deposit → active → inactive)
2. `public.customer_portfolios.status` (pending → active → inactive)  
3. `lth_pvr.customer_strategies.live_enabled` (true/false)

The first two were synced, but the third was missing.

### Fix
Updated `ef_deposit_scan` (lines 176-248) to:
1. Query portfolio details (strategy_code, exchange_account_id)
2. Get latest strategy_version_id from `lth_pvr.strategy_versions` WHERE strategy_code = portfolio.strategy_code AND is_latest = true
3. Insert row into `lth_pvr.customer_strategies` with:
   - `org_id`, `customer_id`, `strategy_version_id`, `exchange_account_id`
   - `live_enabled = true`
   - `effective_from = CURRENT_DATE`
   - `portfolio_id`

### Deployed
- **Function:** ef_deposit_scan
- **Date:** 2026-01-05
- **Command:** `supabase functions deploy ef_deposit_scan --project-ref wqnmxpooabmedvtackji --no-verify-jwt`

### Manual Fix Required
Customer 39 needs backfill since they were activated before the fix. Run queries from:
```
fix_customer_39.sql
```

Key query (uncomment and run after verifying data):
```sql
INSERT INTO lth_pvr.customer_strategies (
  org_id, customer_id, strategy_version_id, exchange_account_id,
  live_enabled, effective_from, portfolio_id
)
SELECT
  cd.org_id, 39::bigint, sv.strategy_version_id, cp.exchange_account_id,
  true, CURRENT_DATE, cp.portfolio_id
FROM public.customer_details cd
JOIN public.customer_portfolios cp ON cd.customer_id = cp.customer_id
CROSS JOIN lth_pvr.strategy_versions sv
WHERE cd.customer_id = 39
  AND sv.strategy_code = cp.strategy_code
  AND sv.is_latest = true
  AND NOT EXISTS (SELECT 1 FROM lth_pvr.customer_strategies cs WHERE cs.customer_id = 39);
```

---

## Bug 2: trade_start_date Not Populating

### Problem
- `customer_details.trade_start_date` remained NULL after customer activation
- This field should record the date when the customer's first strategy becomes active
- Used for reporting, analytics, and age calculations

### Root Cause
The activation logic in `ef_deposit_scan` never set this field.

### Fix
Updated `ef_deposit_scan` (lines 239-248) to:
```typescript
const { error: tradeStartDateError } = await supabase
  .from("customer_details")
  .update({ trade_start_date: new Date().toISOString().split('T')[0] })
  .eq("customer_id", customer.customer_id)
  .is("trade_start_date", null); // Only set if not already set
```

### Deployed
- **Function:** ef_deposit_scan
- **Date:** 2026-01-05
- **Same deployment as Bug 1 fix**

### Manual Fix Required
For existing customers (31, 39), run:
```sql
UPDATE public.customer_details
SET trade_start_date = CURRENT_DATE
WHERE customer_id IN (31, 39)
  AND trade_start_date IS NULL;
```

---

## Bug 3: CI Bands Fetching Today's Data

### Problem
- `ef_fetch_ci_bands` was fetching last 5 days of data by default (including today)
- Today's CI bands data changes throughout the day and is only finalized at day's close
- Trading decisions made at 03:00 UTC should use **YESTERDAY's finalized CI bands** (signal_date = trade_date - 1)
- **Result:** Pipeline could make decisions based on incomplete/changing data

### Root Cause
Default `days` parameter was set to 5 for "self-healing" purposes, but this is only needed for backfill scenarios, not daily pipeline runs.

### Fix
Updated `ef_fetch_ci_bands` to:
1. Calculate `yesterdayStr` = today - 1 day (lines 84-86)
2. Changed default `days` from 5 to 1 (line 93)
3. When no explicit date range provided, explicitly set `start` and `end` to `yesterdayStr` (lines 122-126)

Before:
```typescript
const days = 5; // Default: fetch last 5 days
if (!start && !end && days > 1) url += `&days=${days}`;
```

After:
```typescript
const yesterday = new Date();
yesterday.setUTCDate(yesterday.getUTCDate() - 1);
const yesterdayStr = yesterday.toISOString().slice(0, 10);
const days = 1; // Default: fetch yesterday only

if (!start && !end) {
  url += `&start=${encodeURIComponent(yesterdayStr)}&end=${encodeURIComponent(yesterdayStr)}`;
}
```

### Deployed
- **Function:** ef_fetch_ci_bands
- **Date:** 2026-01-05  
- **Command:** `supabase functions deploy ef_fetch_ci_bands --project-ref wqnmxpooabmedvtackji --no-verify-jwt`

### Verification
Tomorrow's pipeline run (2026-01-06 03:00 UTC) will fetch 2026-01-05 CI bands data. Verify with:
```sql
SELECT date, btc_price, fetched_at 
FROM lth_pvr.ci_bands_daily 
WHERE date = '2026-01-05' 
ORDER BY fetched_at DESC 
LIMIT 1;
```

---

## Testing Next Steps

### 1. Manual Fix for Customer 39
Run queries from `fix_customer_39.sql` to:
- Create missing `customer_strategies` row
- Set `trade_start_date`
- Verify both fields are populated

### 2. Verify Tomorrow's Pipeline (2026-01-06 03:00 UTC)
After pipeline run, check:

**A. Customer 39 has trading decisions:**
```sql
SELECT customer_id, trade_date, signal_date, action, bucket, btc_usdt, memo
FROM lth_pvr.decisions_daily
WHERE trade_date = '2026-01-06'
  AND customer_id = 39;
```

**B. CI bands data is for yesterday (2026-01-05):**
```sql
SELECT date, btc_price, fetched_at
FROM lth_pvr.ci_bands_daily
WHERE date = '2026-01-05'
ORDER BY fetched_at DESC
LIMIT 1;
```

**C. Only active customers have decisions:**
```sql
SELECT dd.customer_id, cd.first_names, cd.last_name, cd.registration_status
FROM lth_pvr.decisions_daily dd
JOIN public.customer_details cd ON dd.customer_id = cd.customer_id
WHERE dd.trade_date = '2026-01-06';
-- Should only show customers with registration_status='active'
```

### 3. Verify Future Activations
When next customer gets activated by `ef_deposit_scan`, verify:
- `customer_strategies` row created automatically ✓
- `trade_start_date` populated automatically ✓
- Customer included in next day's trading pipeline ✓

---

## Documentation Updates

Updated documents:
1. **SDD_v0.6.md** → v0.6.8
   - Added changelog entry with all 3 bug fixes
   - Updated Milestone 5 documentation
   - Updated ef_fetch_ci_bands documentation

2. **fix_customer_39.sql** (NEW)
   - SQL queries to backfill Customer 39

---

## Impact Assessment

### Immediate Impact
- **Customer 39:** Missing from today's (2026-01-05) trading pipeline
  - No decision generated
  - No order placed
  - **Action Required:** Manual SQL fix, will be included tomorrow (2026-01-06)

- **Future Customers:** All new activations will work correctly going forward

### CI Bands Impact
- **Today's Run (2026-01-05 03:00 UTC):** May have fetched incomplete data for 2026-01-05
  - **Verification:** Check `lth_pvr.ci_bands_daily` to see if today's date is present
  - **If present:** Data may be inaccurate (changed throughout the day)
  - **Fix:** Tomorrow's run (2026-01-06) will fetch correct finalized data for 2026-01-05

- **Tomorrow's Run (2026-01-06 03:00 UTC):** Will fetch correct yesterday data (2026-01-05)

### trade_start_date Impact
- **Customers 31 & 39:** Need manual SQL update to set trade_start_date
- **Future Customers:** Will auto-populate correctly

---

## Production Deployment Checklist

Before go-live (2026-01-10):

- [ ] Run `fix_customer_39.sql` queries to backfill Customer 39
- [ ] Update `trade_start_date` for Customers 31 & 39
- [ ] Verify 2026-01-06 pipeline includes Customer 39 in decisions
- [ ] Verify CI bands data for 2026-01-05 was fetched on 2026-01-06
- [ ] Test new customer activation flow (Milestone 5 → 6)
- [ ] Verify customer_strategies row auto-creation
- [ ] Verify trade_start_date auto-population
- [ ] Complete remaining M6 test cases (TC6.1, TC6.2, TC6.4, TC6.5, TC6.6)
- [ ] Run security tests (ST1, ST2, ST3)
- [ ] Update Customer_Onboarding_Test_Cases.md with M6 results

---

## Files Modified

1. `supabase/functions/ef_deposit_scan/index.ts`
   - Lines 176-248: Added customer_strategies creation + trade_start_date population

2. `supabase/functions/ef_fetch_ci_bands/index.ts`
   - Lines 82-93: Calculate yesterday's date, change default days from 5 to 1
   - Lines 117-126: Explicitly set start/end to yesterday when no range provided

3. `docs/SDD_v0.6.md`
   - Lines 11-49: Added v0.6.8 changelog entry
   - Line 207: Updated Milestone 5 documentation
   - Lines 633-640: Updated ef_fetch_ci_bands documentation

4. `fix_customer_39.sql` (NEW)
   - Manual fix queries for Customer 39 backfill

---

**Status:** All fixes deployed and documented. Manual SQL fixes required for Customer 39. Verification after tomorrow's pipeline run (2026-01-06 03:00 UTC).
