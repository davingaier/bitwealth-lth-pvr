<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Portal - BitWealth</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/portal.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Minimal custom overrides for portal-specific features */
        .milestone-track {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
            position: relative;
        }
        .milestone {
            position: relative;
            z-index: 2;
            text-align: center;
            flex: 1;
        }
        .milestone-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            transition: all 0.3s;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .milestone.complete .milestone-circle {
            background: var(--gold);
            color: var(--bg-dark);
            border-color: var(--gold);
        }
        .milestone-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .progress-line {
            position: absolute;
            top: 25px;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 1;
        }
        .progress-fill {
            height: 100%;
            background: var(--gold);
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar">
            <div class="sidebar-header">
                <img src="images/logo.png" alt="BitWealth Logo" style="padding: 4px;">
                <span>BitWealth</span>
            </div>
            
            <nav class="sidebar-nav">
                <a href="#dashboard" class="nav-item active" onclick="scrollToSection('dashboard'); return false;">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="#onboarding" class="nav-item" onclick="scrollToSection('onboarding'); return false;">
                    <span class="icon">üéØ</span>
                    <span>Onboarding</span>
                </a>
                <a href="#transactions" class="nav-item" onclick="scrollToSection('transactions'); return false;">
                    <span class="icon">üìú</span>
                    <span>Transactions</span>
                </a>
                <a href="#statements" class="nav-item" onclick="scrollToSection('statements'); return false;">
                    <span class="icon">üìÑ</span>
                    <span>Statements</span>
                </a>
                <a href="#withdrawals" class="nav-item">
                    <span class="icon">üí∏</span>
                    <span>Withdrawals</span>
                </a>
                <a href="#settings" class="nav-item">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <button class="btn-secondary btn-block" onclick="logout()">Sign Out</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Header -->
            <header class="dashboard-header">
                <div>
                    <h1>Welcome, <span id="customerName">...</span>! üëã</h1>
                    <p class="text-secondary">Your BitWealth Investment Dashboard</p>
                </div>
                <div class="header-actions">
                    <div class="user-avatar" id="userAvatar">?</div>
                </div>
            </header>

            <div id="loading" class="loading" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                <p>Loading your portfolio data...</p>
            </div>

            <div id="content" style="display: none;">
                <!-- Dashboard Section -->
                <section id="dashboard">
                    <!-- Alert Messages -->
                    <div id="noDataMessage" class="alert" style="display: none; background: rgba(251, 191, 36, 0.1); border-left: 4px solid var(--gold); padding: 15px; border-radius: 8px; margin-bottom: 20px; color: var(--gold); font-weight: 500;">
                        <strong>üìä Trading starts tomorrow!</strong><br>
                        Your portfolio data will appear here after your first trading day.
                    </div>

                    <!-- Stats Grid -->
                    <div class="dashboard-stats" id="dashboardStats" style="display: none;">
                        <div class="stat-box">
                            <div class="stat-header">
                                <span>Net Asset Value</span>
                                <span class="stat-icon">üí∞</span>
                            </div>
                            <div class="stat-value" id="navValue">$0.00</div>
                            <div class="stat-change neutral" id="navChange">--</div>
                        </div>

                        <div class="stat-box">
                            <div class="stat-header">
                                <span>BTC Holdings</span>
                                <span class="stat-icon">‚Çø</span>
                            </div>
                            <div class="stat-value" id="btcValue">0.00000000</div>
                            <div class="stat-change neutral" id="btcUsd">--</div>
                        </div>

                        <div class="stat-box">
                            <div class="stat-header">
                                <span>USDT Balance</span>
                                <span class="stat-icon">üíµ</span>
                            </div>
                            <div class="stat-value" id="usdtValue">$0.00</div>
                            <div class="stat-change neutral">Cash reserves</div>
                        </div>

                        <div class="stat-box">
                            <div class="stat-header">
                                <span>Total Returns</span>
                                <span class="stat-icon">üìà</span>
                            </div>
                            <div class="stat-value" id="roiValue">--</div>
                            <div class="stat-change positive" id="roiProfit">--</div>
                        </div>
                    </div>

                    <!-- Dashboard Grid: Recent Activity + Strategy Metrics -->
                    <div class="dashboard-grid" id="dashboardGrid" style="display: none;">
                        <!-- Recent Activity -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h2>Recent Activity</h2>
                                <a href="#transactions" class="link-primary" onclick="scrollToSection('transactions'); return false;">View all</a>
                            </div>
                            <div class="activity-list" id="recentActivity">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Strategy Metrics -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h2>Strategy Metrics</h2>
                            </div>
                            <div class="metrics-list" id="strategyMetrics">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Onboarding Status Section -->
                <section id="onboarding">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h2>üéØ Onboarding Status</h2>
                        </div>
                        <div class="milestone-track">
                            <div class="progress-line">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="milestone" id="m1">
                                <div class="milestone-circle">1</div>
                                <div class="milestone-label">Prospect</div>
                            </div>
                            <div class="milestone" id="m2">
                                <div class="milestone-circle">2</div>
                                <div class="milestone-label">Strategy</div>
                            </div>
                            <div class="milestone" id="m3">
                                <div class="milestone-circle">3</div>
                                <div class="milestone-label">KYC</div>
                            </div>
                            <div class="milestone" id="m4">
                                <div class="milestone-circle">4</div>
                                <div class="milestone-label">VALR Setup</div>
                            </div>
                            <div class="milestone" id="m5">
                                <div class="milestone-circle">5</div>
                                <div class="milestone-label">Deposit</div>
                            </div>
                            <div class="milestone" id="m6">
                                <div class="milestone-circle">6</div>
                                <div class="milestone-label">Active</div>
                            </div>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.1); border-left: 4px solid #10b981; padding: 15px; border-radius: 8px; margin-top: 20px; color: #10b981; font-weight: 500;">
                            <strong>Status:</strong> <span id="nextAction">Loading...</span>
                        </div>
                    </div>
                </section>

                <!-- Portfolio List Section -->
                <section id="portfolios" style="margin-top: 32px;">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h2>üíº Your Portfolios</h2>
                        </div>
                        <div id="portfolioList" style="padding: 20px; color: var(--text-secondary);">Loading portfolios...</div>
                    </div>
                </section>

                <!-- Transaction History Section -->
                <section id="transactions" style="margin-top: 32px;">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h2>üìú Transaction History</h2>
                        </div>
                        <div id="transactionHistory">
                            <div id="transactionLoading" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                Loading transactions...
                            </div>
                            <div id="transactionError" style="display: none; padding: 15px; background: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; color: #ef4444; border-radius: 8px;">
                                Error loading transactions. Please refresh the page.
                            </div>
                            <div id="transactionTable" style="display: none;">
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: rgba(255, 255, 255, 0.05); border-bottom: 2px solid rgba(255, 255, 255, 0.1);">
                                                <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Date</th>
                                        <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Type</th>
                                        <th style="padding: 12px; text-align: right; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">BTC</th>
                                        <th style="padding: 12px; text-align: right; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">USDT</th>
                                        <th style="padding: 12px; text-align: right; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;" title="VALR exchange trading fees">Exchange Fee (BTC)</th>
                                        <th style="padding: 12px; text-align: right; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;" title="VALR exchange trading fees">Exchange Fee (USDT)</th>
                                        <th style="padding: 12px; text-align: right; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;" title="BitWealth platform fee (0.75%)">Platform Fee (BTC)</th>
                                        <th style="padding: 12px; text-align: right; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;" title="BitWealth platform fee (0.75%)">Platform Fee (USDT)</th>
                                        <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Note</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionTableBody">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="noTransactions" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                            <p style="font-size: 16px; margin-bottom: 10px;">üì≠ No transactions yet</p>
                            <p style="font-size: 14px;">Transactions will appear here after your first trade.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Statements Section -->
            <section id="statements" style="margin-top: 32px;">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2>üìÑ Monthly Statements</h2>
                    </div>
                    <div style="padding: 20px;">
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            Download your monthly investment statement as a PDF. Includes performance summary, transaction history, and portfolio details.
                        </p>
                        
                        <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: var(--text-secondary);">Month</label>
                                <select id="statementMonth" style="padding: 10px 15px; background: var(--bg-dark); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: var(--text-primary); font-size: 14px; min-width: 150px;">
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: var(--text-secondary);">Year</label>
                                <select id="statementYear" style="padding: 10px 15px; background: var(--bg-dark); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: var(--text-primary); font-size: 14px; min-width: 120px;">
                                    <!-- Years will be populated by JavaScript -->
                                </select>
                            </div>
                            
                            <button onclick="downloadStatement()" class="btn-primary" style="padding: 10px 24px; background: var(--gold); color: var(--bg-dark); border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: opacity 0.2s;">
                                üì• Download PDF
                            </button>
                        </div>
                        
                        <div id="statementStatus" style="margin-top: 15px; padding: 12px; border-radius: 8px; display: none;">
                            <!-- Status messages will appear here -->
                        </div>
                    </div>
                </div>
            </section>

            </div> <!-- End #content -->
        </main> <!-- End dashboard-main -->
    </div> <!-- End dashboard-container -->

    <script>
        const SUPABASE_URL = 'https://wqnmxpooabmedvtackji.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indxbm14cG9vYWJtZWR2dGFja2ppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwNTY3OTksImV4cCI6MjA2OTYzMjc5OX0.kiNGXtYrUoeud-rKav-o2Vs5x7BZdgG_GVF6MLWE-zs';
        const ORG_ID = 'b0a77009-03b9-44a1-ae1d-34f157d44a8b'; // BitWealth organization ID

        const { createClient } = supabase;
        const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let customerData = null;

        // Helper function for navigation scrolling
        function scrollToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Update active nav item
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.target.closest('.nav-item')?.classList.add('active');
            }
        }

        async function initPortal() {
            // Check if user is authenticated
            const { data: { session }, error } = await sb.auth.getSession();
            
            if (error || !session) {
                // Not logged in - redirect to login
                window.location.href = 'login.html';
                return;
            }

            currentUser = session.user;
            await loadCustomerData();
        }

        async function loadCustomerData() {
            try {
                // Get customer details by email (handle duplicates gracefully)
                const { data: customerList, error: customerError } = await sb
                    .from('customer_details')
                    .select('*')
                    .eq('email', currentUser.email)
                    .order('customer_id', { ascending: false })
                    .limit(1);

                if (customerError || !customerList || customerList.length === 0) throw customerError;
                
                customerData = customerList[0];
                
                // Update header with customer name
                document.getElementById('customerName').textContent = `${customerData.first_names} ${customerData.last_name}`;
                
                // Set user avatar initials
                const initials = (customerData.first_names?.[0] || '') + (customerData.last_name?.[0] || '');
                document.getElementById('userAvatar').textContent = initials.toUpperCase();

                // Load onboarding status
                await loadOnboardingStatus(customerData.customer_id);

                // Load portfolios
                await loadPortfolios(customerData.customer_id);

                // Load portfolio dashboard (balances)
                await loadDashboard(customerData.customer_id);

                // Load recent activity (dashboard card)
                await loadRecentActivity(customerData.customer_id);

                // Load strategy metrics (dashboard card)
                await loadStrategyMetrics(customerData.customer_id);

                // Load transaction history
                await loadTransactionHistory(customerData.customer_id);

                // Initialize statement form with customer's account creation date
                initializeStatementForm();

                // Show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';

            } catch (error) {
                console.error('Error loading customer data:', error);
                alert('Error loading your data. Please try again or contact support.');
            }
        }

        async function loadOnboardingStatus(customerId) {
            try {
                const { data, error } = await sb.rpc('get_customer_onboarding_status', { 
                    p_customer_id: customerId 
                });

                if (error) throw error;

                // Update milestone indicators
                const milestones = data.milestone_statuses || [false, false, false, false, false, false];
                milestones.forEach((complete, index) => {
                    const milestoneEl = document.getElementById(`m${index + 1}`);
                    if (complete) {
                        milestoneEl.classList.add('complete');
                    }
                });

                // Update progress bar
                const progress = (data.current_milestone / 6) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;

                // Update status message
                let statusMessage = data.next_action;
                
                // Override message for inactive customers
                if (customerData.registration_status === 'inactive') {
                    statusMessage = 'Your account is currently inactive. Trading is paused. Contact support to reactivate.';
                }
                
                document.getElementById('nextAction').textContent = statusMessage;

            } catch (error) {
                console.error('Error loading onboarding status:', error);
            }
        }

        async function loadPortfolios(customerId) {
            try {
                const { data: portfolios, error } = await sb.rpc('list_customer_portfolios', {
                    p_customer_id: customerId
                });

                if (error) throw error;

                const container = document.getElementById('portfolioList');
                
                if (!portfolios || portfolios.length === 0) {
                    container.innerHTML = '<p>No portfolios found.</p>';
                    return;
                }

                container.innerHTML = portfolios.map(p => `
                    <div class="stat-box" style="margin-bottom: 10px;">
                        <div class="stat-label">${p.strategy_code} - ${p.status.toUpperCase()}</div>
                        <div style="font-size: 14px; color: #64748b; margin-top: 5px;">
                            Created: ${new Date(p.created_at).toLocaleDateString()}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading portfolios:', error);
                document.getElementById('portfolioList').innerHTML = '<p>Error loading portfolios.</p>';
            }
        }

        async function loadDashboard(customerId) {
            try {
                const { data: portfolios, error } = await sb.rpc('list_customer_portfolios', {
                    p_customer_id: customerId
                });

                if (error) throw error;

                // Check if we have portfolio data
                if (!portfolios || portfolios.length === 0) {
                    // No portfolio found - customer still in onboarding
                    document.getElementById('noDataMessage').innerHTML = 
                        '<strong>‚è≥ Portfolio Not Ready</strong><br>' +
                        'Your portfolio is being set up. You will be notified when your account is ready for trading.';
                    document.getElementById('noDataMessage').style.display = 'block';
                    return;
                }

                const portfolio = portfolios[0];

                // Show dashboard if:
                // 1. Portfolio is active or inactive (both can view balances)
                // 2. nav_usd is not null/undefined (even if zero)
                const canViewDashboard = (portfolio.status === 'active' || portfolio.status === 'inactive') && 
                                        portfolio.nav_usd !== null && 
                                        portfolio.nav_usd !== undefined;
                
                if (canViewDashboard) {
                    // Calculate values
                    const nav = parseFloat(portfolio.nav_usd);
                    const btcPrice = parseFloat(portfolio.btc_price || 0);
                    
                    // Get withdrawable balance (excludes accumulated fees - customer only sees what they can withdraw)
                    let btc = parseFloat(portfolio.btc_balance || 0);
                    let usdt = parseFloat(portfolio.usdt_balance || 0);
                    
                    try {
                        const { data: withdrawable, error: wErr } = await sb
                            .schema('lth_pvr')
                            .rpc('get_withdrawable_balance', { p_customer_id: customerId });
                        
                        if (!wErr && withdrawable && withdrawable.length > 0) {
                            const wb = withdrawable[0];
                            // Use withdrawable amounts (excludes BitWealth's accumulated fees)
                            btc = parseFloat(wb.withdrawable_btc || 0);
                            usdt = parseFloat(wb.withdrawable_usdt || 0);
                        }
                    } catch (wbErr) {
                        console.error('Error fetching withdrawable balance:', wbErr);
                        // Fallback to recorded balances if RPC fails
                    }
                    
                    // Format and update stat boxes
                    document.getElementById('navValue').textContent = `$${nav.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    document.getElementById('btcValue').textContent = `${btc.toFixed(8)}`;
                    document.getElementById('btcUsd').textContent = btcPrice > 0 ? `@ $${btcPrice.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}` : '--';
                    document.getElementById('usdtValue').textContent = `$${usdt.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    
                    // Calculate ROI if we have contribution data
                    const totalContrib = parseFloat(portfolio.total_contributions || 0);
                    if (totalContrib > 0) {
                        const profit = nav - totalContrib;
                        const roi = ((profit / totalContrib) * 100);
                        document.getElementById('roiValue').textContent = `${roi >= 0 ? '+' : ''}${roi.toFixed(1)}%`;
                        document.getElementById('roiProfit').textContent = `${profit >= 0 ? '+' : ''}$${Math.abs(profit).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})} profit`;
                        
                        // Update stat-change class based on positive/negative
                        const roiChangeEl = document.getElementById('roiProfit');
                        roiChangeEl.className = roi >= 0 ? 'stat-change positive' : 'stat-change negative';
                    } else {
                        document.getElementById('roiValue').textContent = '--';
                        document.getElementById('roiProfit').textContent = '--';
                    }

                    // Show dashboard stats
                    document.getElementById('dashboardStats').style.display = 'grid';
                    document.getElementById('dashboardGrid').style.display = 'grid';

                    // Update alert message based on status
                    if (portfolio.status === 'inactive') {
                        document.getElementById('noDataMessage').innerHTML = 
                            '<strong>‚è∏ Account Inactive</strong><br>' +
                            'Your account is currently inactive. Trading is paused. Contact support to reactivate your account.';
                        document.getElementById('noDataMessage').style.display = 'block';
                    } else if (portfolio.status === 'active' && !portfolio.has_trading_history) {
                        // Active customer with no trading decisions yet
                        document.getElementById('noDataMessage').innerHTML = 
                            '<strong>üìä Trading starts tomorrow!</strong><br>' +
                            'Your account is active. The first trading decision will be generated at 03:00 UTC tomorrow morning.';
                        document.getElementById('noDataMessage').style.display = 'block';
                    } else {
                        // Active customer with trade history - hide message
                        document.getElementById('noDataMessage').style.display = 'none';
                    }
                } else {
                    // Portfolio not active/inactive yet OR no balance data - show onboarding message
                    document.getElementById('noDataMessage').innerHTML = 
                        '<strong>‚è≥ Account Setup In Progress</strong><br>' +
                        'Your portfolio is being configured. You will be notified when your account is ready for trading.';
                    document.getElementById('noDataMessage').style.display = 'block';
                }

            } catch (error) {
                console.error('Error loading dashboard:', error);
                // On error, show generic message
                document.getElementById('noDataMessage').innerHTML = 
                    '<strong>‚ö†Ô∏è Unable to Load Dashboard</strong><br>' +
                    'There was an error loading your portfolio data. Please refresh the page or contact support if the problem persists.';
                document.getElementById('noDataMessage').style.display = 'block';
            }
        }

        // Helper function to format time ago (e.g., "2 hours ago")
        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days}d ago`;
            const weeks = Math.floor(days / 7);
            if (weeks < 4) return `${weeks}w ago`;
            return date.toLocaleDateString();
        }

        async function loadRecentActivity(customerId) {
            try {
                // Fetch recent transactions (last 5)
                const { data: transactions, error } = await sb.rpc('list_customer_transactions', {
                    p_customer_id: customerId,
                    p_limit: 5
                });

                if (error) throw error;

                const activityList = document.getElementById('recentActivity');
                
                if (!transactions || transactions.length === 0) {
                    activityList.innerHTML = '<div class="activity-item"><div class="activity-content"><div class="activity-title">No activity yet</div><div class="activity-time">Check back after your first trade</div></div></div>';
                    return;
                }

                // Build activity HTML
                let activityHTML = '';
                transactions.forEach(tx => {
                    const action = tx.kind;
                    const btcAmount = parseFloat(tx.amount_btc || 0);
                    const usdtAmount = parseFloat(tx.amount_usdt || 0);
                    const timestamp = tx.trade_date;
                    
                    let icon = 'üí∞';
                    let description = '';
                    
                    if (action === 'deposit' || action === 'topup') {
                        icon = 'üíµ';
                        description = `Deposit $${Math.abs(usdtAmount).toFixed(2)} USDT`;
                    } else if (action === 'buy') {
                        icon = 'üìà';
                        description = `Bought ${Math.abs(btcAmount).toFixed(8)} BTC`;
                    } else if (action === 'sell') {
                        icon = 'üìâ';
                        description = `Sold ${Math.abs(btcAmount).toFixed(8)} BTC`;
                    } else if (action === 'withdrawal') {
                        icon = 'üí∏';
                        description = `Withdrawal $${Math.abs(usdtAmount).toFixed(2)} USDT`;
                    } else {
                        // Generic fallback
                        if (btcAmount !== 0) {
                            description = `${action} ${Math.abs(btcAmount).toFixed(8)} BTC`;
                        } else {
                            description = `${action} $${Math.abs(usdtAmount).toFixed(2)} USDT`;
                        }
                    }
                    
                    activityHTML += `
                        <div class="activity-item">
                            <div class="activity-icon">${icon}</div>
                            <div class="activity-content">
                                <div class="activity-title">${description}</div>
                                <div class="activity-time">${getTimeAgo(timestamp)}</div>
                            </div>
                        </div>
                    `;
                });
                
                activityList.innerHTML = activityHTML;

            } catch (error) {
                console.error('Error loading activity:', error);
                document.getElementById('recentActivity').innerHTML = '<div class="activity-item"><div class="activity-content"><div class="activity-title">Unable to load activity</div></div></div>';
            }
        }

        async function loadStrategyMetrics(customerId) {
            try {
                // Fetch portfolio data for metrics
                const { data: portfolios, error } = await sb.rpc('list_customer_portfolios', {
                    p_customer_id: customerId
                });

                if (error) throw error;

                const metricsList = document.getElementById('strategyMetrics');
                
                if (!portfolios || portfolios.length === 0) {
                    metricsList.innerHTML = '<div class="metric-item"><div class="metric-label">No data available</div><div class="metric-value">--</div></div>';
                    return;
                }

                const portfolio = portfolios[0];
                
                // Calculate metrics
                const totalContrib = parseFloat(portfolio.total_contributions || 0);
                const nav = parseFloat(portfolio.nav_usd || 0);
                const btcPrice = parseFloat(portfolio.btc_price || 0);
                const btcBalance = parseFloat(portfolio.btc_balance || 0);
                
                // Calculate average cost basis (total USDT spent / total BTC bought)
                // This is a simplified calculation - could be enhanced with actual transaction data
                let avgCostBasis = 0;
                if (btcBalance > 0 && totalContrib > 0) {
                    avgCostBasis = totalContrib / btcBalance;
                }
                
                // Calculate unrealized P/L
                const unrealizedPL = nav - totalContrib;
                const unrealizedPercent = totalContrib > 0 ? ((unrealizedPL / totalContrib) * 100) : 0;
                
                // Build metrics HTML
                const metricsHTML = `
                    <div class="metric-item">
                        <div class="metric-label">Total Invested</div>
                        <div class="metric-value">$${totalContrib.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Current Value</div>
                        <div class="metric-value">$${nav.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Unrealized P/L</div>
                        <div class="metric-value ${unrealizedPL >= 0 ? 'positive' : 'negative'}">
                            ${unrealizedPL >= 0 ? '+' : ''}$${unrealizedPL.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})} 
                            (${unrealizedPercent >= 0 ? '+' : ''}${unrealizedPercent.toFixed(1)}%)
                        </div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Avg Cost Basis</div>
                        <div class="metric-value">${avgCostBasis > 0 ? '$' + avgCostBasis.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0}) : '--'}</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Current BTC Price</div>
                        <div class="metric-value">$${btcPrice.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                    </div>
                `;
                
                metricsList.innerHTML = metricsHTML;

            } catch (error) {
                console.error('Error loading metrics:', error);
                document.getElementById('strategyMetrics').innerHTML = '<div class="metric-item"><div class="metric-label">Unable to load metrics</div><div class="metric-value">--</div></div>';
            }
        }

        async function loadTransactionHistory(customerId) {
            try {
                const { data: transactions, error } = await sb.rpc('list_customer_transactions', {
                    p_customer_id: customerId,
                    p_limit: 100
                });

                if (error) throw error;

                // Hide loading, show table
                document.getElementById('transactionLoading').style.display = 'none';
                document.getElementById('transactionTable').style.display = 'block';

                if (!transactions || transactions.length === 0) {
                    // No transactions yet
                    document.getElementById('noTransactions').style.display = 'block';
                    return;
                }

                // Populate table
                const tbody = document.getElementById('transactionTableBody');
                tbody.innerHTML = transactions.map(tx => {
                    // Format date as DD/MM/YYYY
                    const dateObj = new Date(tx.trade_date);
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const year = dateObj.getFullYear();
                    const date = `${day}/${month}/${year}`;
                    
                    // Determine type display and color
                    let typeDisplay = tx.kind.charAt(0).toUpperCase() + tx.kind.slice(1);
                    let typeColor = '#64748b'; // default gray
                    
                    // Map "topup" to "Deposit" for display
                    if (tx.kind === 'topup') {
                        typeDisplay = 'Deposit';
                    }
                    
                    if (tx.kind === 'buy' || tx.kind === 'deposit' || tx.kind === 'topup') {
                        typeColor = '#10b981'; // green
                    } else if (tx.kind === 'sell' || tx.kind === 'withdrawal') {
                        typeColor = '#ef4444'; // red
                    } else if (tx.kind === 'fee') {
                        typeColor = '#f59e0b'; // orange
                    }
                    
                    // Parse raw amounts for color logic
                    const btcAmountRaw = parseFloat(tx.amount_btc || 0);
                    const usdtAmountRaw = parseFloat(tx.amount_usdt || 0);
                    
                    // Color code amounts based on transaction type
                    let btcColor = '#64748b'; // gray default
                    let usdtColor = '#64748b'; // gray default
                    
                    if (tx.kind === 'deposit' || tx.kind === 'topup') {
                        // USDT deposit: BTC gray, USDT green
                        btcColor = '#64748b';
                        usdtColor = '#10b981';
                    } else if (tx.kind === 'withdrawal') {
                        // USDT withdrawal: BTC gray, USDT red
                        btcColor = '#64748b';
                        usdtColor = '#ef4444';
                    } else if (tx.kind === 'buy') {
                        // BUY: BTC green (receiving), USDT red (spending)
                        btcColor = '#10b981';
                        usdtColor = '#ef4444';
                    } else if (tx.kind === 'sell') {
                        // SELL: BTC red (selling), USDT green (receiving)
                        btcColor = '#ef4444';
                        usdtColor = '#10b981';
                    } else {
                        // Fallback for other types: use sign-based coloring
                        btcColor = btcAmountRaw >= 0 ? '#10b981' : '#ef4444';
                        usdtColor = usdtAmountRaw >= 0 ? '#10b981' : '#ef4444';
                    }
                    
                    // Format amounts
                    const btcAmount = btcAmountRaw.toFixed(8);
                    const usdtAmount = usdtAmountRaw.toFixed(2);
                    const feeBtc = parseFloat(tx.fee_btc || 0).toFixed(8);
                    const feeUsdt = parseFloat(tx.fee_usdt || 0).toFixed(2);
                    
                    // Format platform fees
                    const platformFeeBtc = parseFloat(tx.platform_fee_btc || 0).toFixed(8);
                    const platformFeeUsdt = parseFloat(tx.platform_fee_usdt || 0).toFixed(2);
                    
                    // Color code fees: gray for $0.00, orange for charges
                    const feeBtcColor = parseFloat(tx.fee_btc || 0) > 0 ? '#f59e0b' : '#64748b';
                    const feeUsdtColor = parseFloat(tx.fee_usdt || 0) > 0 ? '#f59e0b' : '#64748b';
                    const platformFeeBtcColor = parseFloat(tx.platform_fee_btc || 0) > 0 ? '#f59e0b' : '#64748b';
                    const platformFeeUsdtColor = parseFloat(tx.platform_fee_usdt || 0) > 0 ? '#f59e0b' : '#64748b';
                    
                    // Note display (truncate long notes)
                    const note = tx.note || '-';
                    const noteDisplay = note.length > 40 ? note.substring(0, 40) + '...' : note;
                    
                    return `
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 12px; font-size: 14px; color: #1e3a8a;">${date}</td>
                            <td style="padding: 12px;">
                                <span style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; color: white; background: ${typeColor};">
                                    ${typeDisplay}
                                </span>
                            </td>
                            <td style="padding: 12px; text-align: right; font-family: monospace; font-size: 13px; color: ${btcColor}; font-weight: 500;">${btcAmount}</td>
                            <td style="padding: 12px; text-align: right; font-family: monospace; font-size: 13px; color: ${usdtColor}; font-weight: 500;">${usdtAmount}</td>
                            <td style="padding: 12px; text-align: right; font-family: monospace; font-size: 13px; color: ${feeBtcColor};">${feeBtc}</td>
                            <td style="padding: 12px; text-align: right; font-family: monospace; font-size: 13px; color: ${feeUsdtColor};">${feeUsdt}</td>
                            <td style="padding: 12px; text-align: right; font-family: monospace; font-size: 13px; color: ${platformFeeBtcColor};">${platformFeeBtc}</td>
                            <td style="padding: 12px; text-align: right; font-family: monospace; font-size: 13px; color: ${platformFeeUsdtColor};">${platformFeeUsdt}</td>
                            <td style="padding: 12px; font-size: 13px; color: #64748b;" title="${note}">${noteDisplay}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading transaction history:', error);
                document.getElementById('transactionLoading').style.display = 'none';
                document.getElementById('transactionError').style.display = 'block';
            }
        }

        async function downloadStatement() {
            if (!customerData || !customerData.customer_id) {
                showStatementStatus('Customer data not loaded', 'error');
                return;
            }

            const month = parseInt(document.getElementById('statementMonth').value);
            const year = parseInt(document.getElementById('statementYear').value);

            if (isNaN(month) || isNaN(year)) {
                showStatementStatus('Please select a valid month and year', 'error');
                return;
            }

            try {
                showStatementStatus('Checking for existing statement...', 'loading');

                // Calculate expected filename (SDD convention)
                const lastDay = new Date(year, month, 0).getDate();
                const endDate = `${year}-${String(month).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
                const lastName = customerData.last_name.replace(/\s+/g, '_');
                const firstNames = customerData.first_names.replace(/\s+/g, '_');
                const monthPadded = String(month).padStart(2, '0');
                const filename = `${endDate}_${lastName}_${firstNames}_statement_M${monthPadded}_${year}.pdf`;
                const storagePath = `${ORG_ID}/customer-${customerData.customer_id}/${filename}`;

                // Try to get existing statement from storage bucket
                const { data: existingFile } = await sb
                    .storage
                    .from('customer-statements')
                    .list(`${ORG_ID}/customer-${customerData.customer_id}`, {
                        search: filename
                    });

                if (existingFile && existingFile.length > 0) {
                    // Pre-generated statement exists, get signed URL
                    const { data: signedData } = await sb
                        .storage
                        .from('customer-statements')
                        .createSignedUrl(storagePath, 60 * 60 * 24 * 30); // 30-day expiry

                    if (signedData?.signedUrl) {
                        showStatementStatus('Downloading pre-generated statement...', 'loading');
                        const a = document.createElement('a');
                        a.href = signedData.signedUrl;
                        a.download = filename;
                        a.target = '_blank';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        showStatementStatus('Statement downloaded successfully!', 'success');
                        return;
                    }
                }

                // No pre-generated statement, generate new one
                showStatementStatus('Generating new PDF statement...', 'loading');

                // Call edge function
                const response = await fetch(`${SUPABASE_URL}/functions/v1/ef_generate_statement`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        customer_id: customerData.customer_id,
                        year: year,
                        month: month
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to generate statement');
                }

                // Get download URL from response
                const result = await response.json();
                
                if (!result.success || !result.downloadUrl) {
                    throw new Error('Failed to generate statement - no download URL');
                }

                // Download PDF from signed URL
                const a = document.createElement('a');
                a.href = result.downloadUrl;
                a.download = result.filename || `BitWealth_Statement_${month}_${year}.pdf`;
                a.target = '_blank'; // Open in new tab as fallback
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                showStatementStatus('Statement downloaded successfully!', 'success');

            } catch (error) {
                console.error('Error downloading statement:', error);
                showStatementStatus(`Failed to generate statement: ${error.message}`, 'error');
            }
        }

        function showStatementStatus(message, type) {
            const statusDiv = document.getElementById('statementStatus');
            statusDiv.style.display = 'block';
            
            if (type === 'loading') {
                statusDiv.style.background = 'rgba(59, 130, 246, 0.1)';
                statusDiv.style.borderLeft = '4px solid #3b82f6';
                statusDiv.style.color = '#3b82f6';
            } else if (type === 'success') {
                statusDiv.style.background = 'rgba(34, 197, 94, 0.1)';
                statusDiv.style.borderLeft = '4px solid #22c55e';
                statusDiv.style.color = '#22c55e';
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            } else if (type === 'error') {
                statusDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                statusDiv.style.borderLeft = '4px solid #ef4444';
                statusDiv.style.color = '#ef4444';
            }
            
            statusDiv.textContent = message;
        }

        function initializeStatementForm() {
            // Populate year dropdown (from account creation year to current year)
            const yearSelect = document.getElementById('statementYear');
            const monthSelect = document.getElementById('statementMonth');
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1; // 1-12
            
            // Get account creation date from customer data (will be set after login)
            const accountCreatedYear = customerData?.created_at 
                ? new Date(customerData.created_at).getFullYear()
                : currentYear - 2; // Default to 2 years ago if not available
            
            // Populate years from account creation to current
            yearSelect.innerHTML = '';
            for (let year = currentYear; year >= accountCreatedYear; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
            
            // Function to update available months based on selected year
            function updateAvailableMonths() {
                const selectedYear = parseInt(yearSelect.value);
                const now = new Date();
                const thisYear = now.getFullYear();
                const thisMonth = now.getMonth() + 1; // 1-12
                const prevMonth = thisMonth === 1 ? 12 : thisMonth - 1;
                const prevMonthYear = thisMonth === 1 ? thisYear - 1 : thisYear;
                
                // Define variables that are needed outside the loop
                const isCurrentYear = selectedYear === thisYear;
                const isPreviousMonthYear = selectedYear === prevMonthYear;
                const isFutureYear = selectedYear > thisYear;
                
                monthSelect.innerHTML = '';
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                
                for (let m = 1; m <= 12; m++) {
                    // Skip if future year or future/current month in current year
                    if (isFutureYear) continue;
                    if (isCurrentYear && m >= thisMonth) continue;
                    
                    // Skip if before account creation
                    if (customerData?.created_at) {
                        const accountCreated = new Date(customerData.created_at);
                        const accountYear = accountCreated.getFullYear();
                        const accountMonth = accountCreated.getMonth() + 1;
                        
                        if (selectedYear < accountYear) continue;
                        if (selectedYear === accountYear && m < accountMonth) continue;
                    }
                    
                    const option = document.createElement('option');
                    option.value = m;
                    option.textContent = monthNames[m - 1];
                    monthSelect.appendChild(option);
                }
                
                // Set default to previous month
                if (monthSelect.querySelector(`option[value="${prevMonth}"]`) && isPreviousMonthYear) {
                    monthSelect.value = prevMonth;
                } else if (monthSelect.options.length > 0) {
                    monthSelect.value = monthSelect.options[monthSelect.options.length - 1].value;
                }
            }
            
            // Update months when year changes
            yearSelect.addEventListener('change', updateAvailableMonths);
            
            // Initial population
            updateAvailableMonths();
        }

        async function logout() {
            await sb.auth.signOut();
            window.location.href = 'login.html';
        }

        // Initialize on page load
        // Note: initializeStatementForm() is called after customer data loads
        initPortal();
    </script>
</body>
</html>
