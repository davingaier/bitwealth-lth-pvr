# 401 Unauthorized Fix for ef_convert_platform_fee_btc

**Date:** 2026-01-24  
**Issue:** Manual test of `ef_convert_platform_fee_btc` returned 401 Unauthorized from VALR API

---

## Root Cause

**Problem:** VALR main account operations were being treated as subaccount operations.

**Symptoms:**
```
VALR MARKET order failed: 401 - {"code":-93,"message":"\"Unauthorized\""}
```

**Three Issues Found:**

1. **Wrong default main account ID**
   - Used: `"0"` 
   - Should be: `""` (empty string)
   - Other functions correctly use empty string for main account

2. **X-VALR-SUB-ACCOUNT-ID header sent unnecessarily**
   - Main account operations should NOT include this header
   - Including the header tells VALR to route to a subaccount
   - Omitting the header = main account operation

3. **Incorrect signVALR parameter**
   - Was passing `mainAccountId` to signVALR
   - Should pass `""` (empty string) for main account signatures

---

## Solution

**Changed in `ef_convert_platform_fee_btc/index.ts`:**

### 1. Default Main Account ID
```typescript
// Before:
const mainAccountId = Deno.env.get("VALR_MAIN_ACCOUNT_ID") || "0";

// After:
const mainAccountId = Deno.env.get("VALR_MAIN_ACCOUNT_ID") || "";
```

### 2. Removed X-VALR-SUB-ACCOUNT-ID Header (placeMarketOrder)
```typescript
// Before:
const signature = await signVALR(timestamp, method, path, body, valrApiSecret, mainAccountId);

const response = await fetch(`https://api.valr.com${path}`, {
  method,
  headers: {
    "Content-Type": "application/json",
    "X-VALR-API-KEY": valrApiKey,
    "X-VALR-SIGNATURE": signature,
    "X-VALR-TIMESTAMP": timestamp,
    "X-VALR-SUB-ACCOUNT-ID": mainAccountId,  // ❌ Wrong for main account
  },
  body,
});

// After:
const signature = await signVALR(timestamp, method, path, body, valrApiSecret, "");

const headers: Record<string, string> = {
  "Content-Type": "application/json",
  "X-VALR-API-KEY": valrApiKey,
  "X-VALR-SIGNATURE": signature,
  "X-VALR-TIMESTAMP": timestamp,
};
// X-VALR-SUB-ACCOUNT-ID header omitted = main account operation ✅

const response = await fetch(`https://api.valr.com${path}`, {
  method,
  headers,
  body,
});
```

### 3. Same Fix for getOrderDetails
```typescript
// Before:
const signature = await signVALR(timestamp, method, path, "", valrApiSecret, mainAccountId);
// headers included X-VALR-SUB-ACCOUNT-ID

// After:
const signature = await signVALR(timestamp, method, path, "", valrApiSecret, "");
// headers do NOT include X-VALR-SUB-ACCOUNT-ID
```

---

## VALR Main Account vs Subaccount Authentication

### Main Account (Primary Trading Account)
```typescript
// No X-VALR-SUB-ACCOUNT-ID header
const signature = await signVALR(timestamp, method, path, body, apiSecret, "");

headers = {
  "X-VALR-API-KEY": apiKey,
  "X-VALR-SIGNATURE": signature,
  "X-VALR-TIMESTAMP": timestamp,
  // X-VALR-SUB-ACCOUNT-ID omitted
};
```

### Subaccount (Customer Isolated Account)
```typescript
// Include X-VALR-SUB-ACCOUNT-ID header
const subaccountId = "1463930536558264320";
const signature = await signVALR(timestamp, method, path, body, apiSecret, subaccountId);

headers = {
  "X-VALR-API-KEY": apiKey,
  "X-VALR-SIGNATURE": signature,
  "X-VALR-TIMESTAMP": timestamp,
  "X-VALR-SUB-ACCOUNT-ID": subaccountId,  // Required for subaccount routing
};
```

**Key Difference:** Omitting the `X-VALR-SUB-ACCOUNT-ID` header = main account operation.

---

## Testing After Fix

### Option B: Manual Conversion Test (Recommended)

```powershell
# Test with actual service role key (replace placeholder)
$serviceRoleKey = "<your-actual-service-role-key>"

curl -X POST https://wqnmxpooabmedvtackji.supabase.co/functions/v1/ef_convert_platform_fee_btc `
  -H "Authorization: Bearer $serviceRoleKey" `
  -H "Content-Type: application/json" `
  -d '{"btc_amount": 0.00001052, "customer_id": 47}'
```

**Expected Success Response:**
```json
{
  "success": true,
  "btc_sold": 0.00001052,
  "usdt_received": 1.05,
  "avg_price": 99808.95,
  "order_id": "valr-order-uuid",
  "order_status": "Filled"
}
```

**Verification:**
```sql
-- Check alert log
SELECT * FROM lth_pvr.alert_events
WHERE component = 'ef_convert_platform_fee_btc'
  AND severity = 'info'
ORDER BY created_at DESC LIMIT 1;
```

---

## Security Check ✅

**Scanned all documentation files for exposed secrets:**
- ✅ No actual API keys found
- ✅ No actual service role keys found  
- ✅ No actual JWT tokens found
- ✅ All examples use placeholders: `[service_role_key]`, `[anon_key]`, `<your-key>`

**Safe to commit to repository.**

---

## Deployment Status

- ✅ **ef_convert_platform_fee_btc** redeployed (2026-01-24 ~14:30)
- ✅ Authentication fixed (main account operations)
- ✅ Ready for testing TC1.2 steps 6 & 7

---

## Next Steps

1. **Retest manual conversion:**
   ```powershell
   # Use actual service role key from Supabase Dashboard
   curl -X POST https://wqnmxpooabmedvtackji.supabase.co/functions/v1/ef_convert_platform_fee_btc `
     -H "Authorization: Bearer $serviceRoleKey" `
     -H "Content-Type: application/json" `
     -d '{"btc_amount": 0.00001052, "customer_id": 47}'
   ```

2. **Verify VALR order on main account:**
   - Check VALR Dashboard → Main Account → Orders History
   - Look for MARKET SELL order: 0.00001052 BTC
   - Customer Order ID: `PLATFORM_FEE_CONV_[timestamp]`

3. **Check conversion logged:**
   ```sql
   SELECT * FROM lth_pvr.alert_events
   WHERE component = 'ef_convert_platform_fee_btc'
   ORDER BY created_at DESC LIMIT 1;
   ```

4. **Complete TC1.2 steps 6 & 7:**
   - Make new BTC deposit to Customer 47
   - Watch auto-conversion trigger after platform fee transfer
   - Update test case status to ✅ PASS

---

**Issue Resolution Time:** ~15 minutes (diagnosis + fix + deployment)  
**Status:** ✅ DEPLOYED & READY FOR TESTING  
**Root Cause:** VALR main account authentication misunderstanding
